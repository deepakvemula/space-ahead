---
import MainLayout from "../../layouts/MainLayout.astro";
import ImageCarousel from "../../components/ImageCarousel.astro";
import {
  fetchListings,
  parseImageUrls,
  extractMapsSrc,
} from "../../utils/listings";
import type { Listing } from "../../utils/listings";

export async function getStaticPaths() {
  const listings = await fetchListings();

  return listings.map((listing) => ({
    params: { slug: listing.Page_Slug },
    props: { listing },
  }));
}

interface Props {
  listing: Listing;
}

const { listing } = Astro.props;

const galleryImages = parseImageUrls(listing.Gallery_Image_URLs);
const floorplanImages = parseImageUrls(listing.Floorplan_Image_URLs);
const mapSrc = extractMapsSrc(listing.Google_Maps_Embed_Link);
const highlights = listing.Key_Highlights
  ? listing.Key_Highlights.split(",")
      .map((h) => h.trim())
      .filter((h) => h)
  : [];
const configurations = listing.Unit_Configurations
  ? listing.Unit_Configurations.split(",")
      .map((c) => c.trim())
      .filter((c) => c)
  : [];

// Map listing status to theme-aligned badge styles
const normalizedStatus = (listing.Project_Status || "").toLowerCase().trim();
const statusStyles: Record<string, string> = {
  "under construction":
    "border-space-yellow text-gray-900 bg-space-yellow/90 dark:text-gray-900 dark:border-space-yellow dark:bg-space-yellow/90",
  "ready to move":
    "border-space-red text-white bg-space-red dark:border-space-yellow dark:text-gray-900 dark:bg-space-yellow/90",
  "new launch":
    "border-space-stone text-white bg-space-stone dark:border-whitesmoke dark:text-gray-900 dark:bg-whitesmoke/90",
  "sold out":
    "border-gray-400 text-white bg-gray-500 dark:border-gray-400 dark:text-gray-900 dark:bg-gray-300",
};
const badgeClass =
  statusStyles[normalizedStatus] ||
  "border-gray-400 text-white bg-gray-600 dark:text-gray-900 dark:bg-gray-300 dark:border-gray-400";
---

<MainLayout
  pageTitle={listing.Meta_Title}
  description={listing.Meta_Description}
>
  <article class="page-content max-w-6xl mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8 sm:mb-12">
      <div
        class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4"
      >
        <div class="flex-1">
          <h1 class="sigmar-ff text-balance mb-3 leading-tight">
            {listing.Project_Name}
          </h1>
          {
            listing.Location_Area && (
              <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 flex items-center gap-2">
                <span class="text-xl">üìç</span>
                <span>{listing.Location_Area}</span>
              </p>
            )
          }
        </div>
        {
          listing.Project_Status && (
            <span
              class={`tag rounded-full text-sm px-4 py-2 border-2 self-start shadow-lg kanit-medium font-bold ${badgeClass}`}
            >
              {listing.Project_Status}
            </span>
          )
        }
      </div>

      {
        listing.Developer_Name && (
          <p class="text-gray-600 dark:text-gray-300 text-sm sm:text-base">
            Developed by{" "}
            <strong class="text-gray-900 dark:text-white">
              {listing.Developer_Name}
            </strong>
          </p>
        )
      }
    </div>

    <!-- Gallery Section -->
    {
      galleryImages.length > 0 && (
        <div class="mb-8">
          <ImageCarousel
            images={galleryImages}
            altPrefix={`${listing.Project_Name} - Image`}
          />
        </div>
      )
    }

    <!-- Price & Key Details Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-8 sm:mb-12">
      <!-- Pricing Card -->
      {
        (listing.Base_Price_Min_Lakhs ||
          listing.Base_Price_Max_Lakhs ||
          listing.Price_Per_Sqft) && (
          <div class="bg-white dark:bg-gray-800/60 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
              Pricing
            </h2>
            <div class="space-y-4">
              {listing.Base_Price_Min_Lakhs && listing.Base_Price_Max_Lakhs && (
                <div>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                    Price Range
                  </p>
                  <p class="text-2xl sm:text-3xl font-bold text-space-red dark:text-space-yellow">
                    ‚Çπ{listing.Base_Price_Min_Lakhs}L - ‚Çπ
                    {listing.Base_Price_Max_Lakhs}L
                  </p>
                </div>
              )}
              {listing.Price_Per_Sqft && (
                <div>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                    Price per sq.ft
                  </p>
                  <p class="text-xl font-semibold text-gray-900 dark:text-white">
                    ‚Çπ{listing.Price_Per_Sqft}
                  </p>
                </div>
              )}
            </div>
          </div>
        )
      }

      <!-- Project Details Card -->
      {
        (listing.Total_Area_Acres ||
          listing.Total_Units ||
          listing.Possession_Date ||
          listing.RERA_Number) && (
          <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
              Project Details
            </h2>
            <div class="space-y-3 text-sm sm:text-base">
              {listing.Total_Area_Acres && (
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-400">
                    Total Area:
                  </span>
                  <span class="font-semibold text-gray-900 dark:text-white">
                    {listing.Total_Area_Acres} Acres
                  </span>
                </div>
              )}
              {listing.Total_Units && (
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-400">
                    Total Units:
                  </span>
                  <span class="font-semibold text-gray-900 dark:text-white">
                    {listing.Total_Units}
                  </span>
                </div>
              )}
              {listing.Possession_Date && (
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-400">
                    Possession Date:
                  </span>
                  <span class="font-semibold text-gray-900 dark:text-white">
                    {listing.Possession_Date}
                  </span>
                </div>
              )}
              {listing.RERA_Number && (
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-400">
                    RERA Number:
                  </span>
                  <span class="font-semibold text-xs sm:text-sm text-gray-900 dark:text-white break-all">
                    {listing.RERA_Number}
                  </span>
                </div>
              )}
            </div>
          </div>
        )
      }
    </div>

    <!-- Unit Configurations -->
    {
      configurations.length > 0 && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            Unit Configurations
          </h2>
          <div class="flex flex-wrap gap-3">
            {configurations.map((config) => (
              <span class="px-4 sm:px-5 py-2 sm:py-2.5 bg-green-100 dark:bg-green-900/50 text-green-900 dark:text-green-100 border border-green-200 dark:border-green-800 rounded-full font-semibold text-sm sm:text-base">
                {config}
              </span>
            ))}
          </div>
          {listing.Min_Size_Sqft && listing.Max_Size_Sqft && (
            <p class="mt-4 text-gray-600 dark:text-gray-300 text-sm sm:text-base">
              Size Range:{" "}
              <strong class="text-gray-900 dark:text-white">
                {listing.Min_Size_Sqft} - {listing.Max_Size_Sqft} sq.ft
              </strong>
            </p>
          )}
        </div>
      )
    }

    <!-- Key Highlights -->
    {
      highlights.length > 0 && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            Key Highlights
          </h2>
          <ul class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
            {highlights.map((highlight) => (
              <li class="flex items-start gap-3 p-3 rounded-lg bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700">
                <span class="text-green-600 dark:text-green-400 mt-0.5 text-lg flex-shrink-0">
                  ‚úì
                </span>
                <span class="text-gray-700 dark:text-gray-200 text-sm sm:text-base">
                  {highlight}
                </span>
              </li>
            ))}
          </ul>
        </div>
      )
    }

    <!-- Project Description -->
    {
      listing.Project_Description && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            About the Project
          </h2>
          <div class="prose prose-gray dark:prose-invert max-w-none">
            <p class="text-gray-700 dark:text-gray-300 leading-relaxed text-sm sm:text-base">
              {listing.Project_Description}
            </p>
          </div>
        </div>
      )
    }

    <!-- Floor Plans -->
    {
      floorplanImages.length > 0 && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            Floor Plans
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            {floorplanImages.map((image, index) => (
              <img
                src={image}
                alt={`Floor Plan ${index + 1}`}
                class="w-full rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"
                loading="lazy"
              />
            ))}
          </div>
        </div>
      )
    }

    <!-- Video -->
    {
      listing.Video_Link && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            Video Tour
          </h2>
          <div class="aspect-video rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
            <iframe
              src={listing.Video_Link.replace("watch?v=", "embed/")}
              class="w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            />
          </div>
        </div>
      )
    }

    <!-- Location Map -->
    {
      mapSrc && listing.Full_Address && (
        <div class="mb-8 sm:mb-12">
          <h2 class="text-2xl font-bold mb-4 sm:mb-6 text-gray-900 dark:text-white">
            Location
          </h2>
          <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm sm:text-base">
            {listing.Full_Address}
          </p>
          <div class="aspect-video rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
            <iframe
              src={mapSrc}
              class="w-full h-full"
              style="border:0;"
              allowfullscreen
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            />
          </div>
        </div>
      )
    }

    <!-- Contact CTA -->
    <section
      role="region"
      aria-labelledby="listing-cta-heading"
      class="rounded-xl p-6 sm:p-8 text-center bg-white/90 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700 shadow-sm max-w-3xl mx-auto"
    >
      <h2
        id="listing-cta-heading"
        class="text-xl sm:text-2xl font-bold mb-2 text-gray-900 dark:text-white"
      >
        Interested in this property?
      </h2>
      <p class="mb-6 text-gray-600 dark:text-gray-300 text-sm sm:text-base">
        Get in touch with us for more details and site visits
      </p>
      <a href="/contact" class="button-link space-btn-filled">Contact Us</a>
    </section>
  </article>
</MainLayout>

<style>
  .prose {
    max-width: 65ch;
  }
</style>
